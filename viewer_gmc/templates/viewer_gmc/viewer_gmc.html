{% extends 'viewer/viewer_layout.html' %}
{% load static %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'viewer/css/style.css' %}">
{% endblock %}

{% block title %}Результаты анализов{% endblock %}

{% block content %}
<div class="container">
    <h2>Результаты анализов</h2>
        <section class="prob-section">
            <form method="get" id="filter-form">
                <div class="row">
                    <div class="column">
                        <label for="id_selection_point">Точка отбора</label>
                        {{ form.selection_point }}
                    </div>

                    <div class="column">
                        <label for="id_date_from">Дата с</label>
                        {{ form.date_from }}
                    </div>

                    <div class="column">
                        <label for="id_date_to">Дата по</label>
                        {{ form.date_to }}
                    </div>
                </div>
            </form>
        </section>

        <!-- Отдельная форма для выгрузки -->
        <form method="get" action="{% url 'viewer_gmc_download_excel' %}">
            <input type="hidden" name="selection_point" value="{{ form.selection_point.value }}">
            <input type="hidden" name="date_from" value="{{ form.date_from.value }}">
            <input type="hidden" name="date_to" value="{{ form.date_to.value }}">
            <div class="buttons">
                <button class="btn" type="submit">Выгрузить данные</button>
            </div>
        </form>
        <h3>Статистика за выбранный период</h3>
        <table>
            <thead>
                <tr>
                    <th>Показатель</th>
                    <th>Минимум</th>
                    <th>Среднее</th>
                    <th>Максимум</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>pH</td>
                    <td>{{ stats.min_ph|floatformat:2 }}</td>
                    <td>{{ stats.avg_ph|floatformat:2 }}</td>
                    <td>{{ stats.max_ph|floatformat:2 }}</td>
                </tr>
                <tr>
                    <td>V2O5 г/л</td>
                    <td>{{ stats.min_v2o5|floatformat:2 }}</td>
                    <td>{{ stats.avg_v2o5|floatformat:2 }}</td>
                    <td>{{ stats.max_v2o5|floatformat:2 }}</td>
                </tr>
                <tr>
                    <td>H2SO4 г/л</td>
                    <td>{{ stats.min_h2so4|floatformat:2 }}</td>
                    <td>{{ stats.avg_h2so4|floatformat:2 }}</td>
                    <td>{{ stats.max_h2so4|floatformat:2 }}</td>
                </tr>
                <tr>
                    <td>MgSO4 г/л</td>
                    <td>{{ stats.min_mgso4|floatformat:2 }}</td>
                    <td>{{ stats.avg_mgso4|floatformat:2 }}</td>
                    <td>{{ stats.max_mgso4|floatformat:2 }}</td>
                </tr>
                <tr>
                    <td>Взвесь г/л</td>
                    <td>{{ stats.min_susp|floatformat:2 }}</td>
                    <td>{{ stats.avg_susp|floatformat:2 }}</td>
                    <td>{{ stats.max_susp|floatformat:2 }}</td>
                </tr>
            </tbody>
        </table>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Проба</th>
                    <th>pH</th>
                    <th>V2O5 г/л</th>
                    <th>H2SO4 г/л</th>
                    <th>MgSO4 г/л</th>
                    <th>Взвесь г/л</th>
                    <th>Усл сухой ост, г/л</th>
                    <th>повтор</th>
                    <th>Время указ.</th>
                    <th>Время факт.</th>
                </tr>
            </thead>
            <tbody>
                {% for value in values_list  %}
                <tr>
                    <td>{{ value.id }}</td>
                    <td>{{ value.selection_point }}</td>
                    <td>{{ value.ph }}</td>
                    <td>{{ value.v2o5|default_if_none:"" }}</td>
                    <td>{{ value.h2so4|default_if_none:"" }}</td>
                    <td>{{ value.mgso4|default_if_none:"" }}</td>
                    <td>{{ value.susp|default_if_none:"" }}</td>
                    <td>{{ value.dry_residue|default_if_none:"" }}</td>
                    <td>
                        {% if value.replace_source == "lab" %}
                        {% elif value.replace_source == "workshop" %}
                            {{ value.replaced_by|default_if_none:"" }}
                        {% else %}
                            {{ value.replace_source|default_if_none:"" }}
                        {% endif %}
                    </td>
                    {% load tz %}
                    <td>{{ value.user_defined_time|default_if_none:""|date:"d.m.Y H:i" }}</td>
                    <td>{{ value.created_at|timezone:"Europe/Moscow"|date:"d.m.Y H:i" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
</div>

<script>
    document.querySelectorAll('#id_selection_point, #id_indicator, #id_date_from, #id_date_to')
        .forEach(el => el.addEventListener('change', () => {
            document.getElementById('filter-form').submit();
        }));
</script>

{% endblock %}
